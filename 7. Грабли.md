##Грабли которые не обходит CoffeeScript

JavaScript это страшный зверь. Знать где разбросаны грабли, на которые кто-то уже наступал не менее важно, чем знать как правильно пользоваться языком. Как говорил [Сунь-Цзы][0]: "знай своего врага", и это именно то, о чем пойдет речь в этой главе. Мы рассмотрим темную сторону JavaScript и обратим внимание на все грабли разложенные для ничего не подозревающих разработчиков.

Как уже было написано во введении, изюминка CoffeeScript не только в его лаконичном синтаксисе, но и в его способности обойти  некоторые шероховатости JavaScript. Однако, в связи с тем, что CoffeeScript лишь транслируется в JavaScript, а не запускается в виртуальной машине или интерпретаторе, язык не является панацеей от всех опасностей и неожиданностей JavaScript, и есть еще ряд вещей, о которых Вы должны знать.

####Подмножество JavaScript

Синтаксис Coffescript покрывает только подмножество Javascript'а, известное как "Лучшие практики", ??so already there's less to fix??. Для примера возьмем выражение `with`. Долгое время его использование считалось вредным и звучали советы избегать его. Подразумевалось что `with` предоставит короткую запись для реккурентного доступа к свойствам объекта. Например, вместо написания:

```javascript
dataObj.users.alex.email = "info@eribium.org";
```

Вы могли бы написать:

```javascript
with(dataObj.users.alex) {
  email = "info@eribium.org";
}
```

Если оставить в стороне тот факт, что нам не следовало бы создавать объекты с такой сильной вложенностью, синтаксис довольно понятен. Но есть одно `НО`. Эта запись является чертовски запутанной для интерпритатора Javascript - он не понимает что именно вы собираетесь сделать в этом контексте и проделывает лишнюю работу.

Такой процесс понижает производительность, он означает что интерпритатору придется отключить любые JIT оптимизации. Кроме того выражения, использующие `with`, не могут быть минифицированы различными инструментами, такими как `uglify-js`. Кроме того, 'with' будет удален из будущих версий Javascript. Учитывая все обстоятельства, правильным шагом будет не использовать это выражение, и Coffeescript уже придпринял шаги для этого, исключая его из своего синтаксиса. Другими словами, использование `with` в Coffeescript вызовет синтаксическую ошибку.

####Глобальные переменные
По умолчанию, Javascript код выполняется в глобальной области видимости. Там же находятся и все созданные переменные. Если вы хотите создать переменную в локальной области видимости, нужно явно указывать это с помощью ключевого слова `var`.

```javascript
usersCount = 1;        // Global
var groupsCount = 2;   // Global

(function(){              
  pagesCount = 3;      // Global
  var postsCount = 4;  // Local
})()
```

Это решение кажется немного странным, так как в подавляющем большинстве случаев вы будете создавать локальные, а не глобальные переменные. Так почему бы не сделать это по умолчанию? В нынешнем виде разработчики должны все время помнить об использовании ключевого слова `var` перед объявлением любой переменной, или они столкнуться со странными багами, из-за того, что переменные будут случайно конфликтовать и перезаписывать друг друга.

??
К счастью, Coffeescript приходит на помощь, полностью уничтожая присваивание неявных глобальных переменных. Другими словами, ключевое слово `var` является зарезервированным в Coddeescript, и его использование вызовет синтаксическую ошибку. Локальные переменные создаются неявными по умолчанию, и вам придется попотеть, чтобы создать глобальную переменную без явного указания ее, как свойства `window`.
??

Взгляните на пример присваивания значения переменной в Coffeescript:

```coffeescript
outerScope = true
do ->
  innerScope = true
```

Компилируется в:

```javascript
var outerScope;
outerScope = true;
(function() {
  var innerScope;
  return innerScope = true;
})();
```

Обратите внимание, что в Coffeescript переменные автоматически инициализируются в том контексте, в котором они используются впервые. Несмотря на то, что ??shadow?? внешнюю переменную, вы все еще имеете доступ к ней и можете на нее ссылаться. Однако, будьте осторожны. Вам придется следить за тем, чтобы случайно не переиспользовать имена внешних переменных, особенно когда вы пишите функции или классы с высокой вложенностью. В примере ниже мы случайно перезаписываем переменнную `package` в методе класса:

```coffeescript
package = require('./package')

class Hem
  build: ->
    # Overwrites outer variable!
    package = @hemPackage.compile()

  hemPackage: ->
    package.create()
```

Иногда возникает необходимость использовать глобальные переменные. Вы можете создать их, задавая свойства объекту `window`:

```coffeescript
  class window.Asset
    constructor: ->
```

Гарантируя, что глобальные переменные создаются только явно, Coffescript избавляет нас от одной из самых распространенных ошибок в программах, написанных на Javascript.

####Точка с запятой
Использование точки с запятой не является обязательным в Javascript, поэтому мы можем опускать их. Тем не менее, Javascript компилятору они, на самом деле, нужны, поэтому парсер автоматически вставляет их там, где встречаются синтаксические ошибки из-за их отсутствия. Другими словами, он пытается выполнить выражение без точки с запятой и, если получает ошибку, он пытается сделать тоже самое уже с ней.

К сожалению, это чрезвычайно плохая идея, которая может привести к изменению поведения в вашем коде. Взгляните на следующий пример с, казалось бы, валидным Javascript кодом:

```javascript
function() {}
(window.options || {}).property
```

Но для парсера это не так; мы получим сообщение о синтаксической ошибке. Если мы будем использовать ??ВЕДУЩИЕ СКОБКИ??, парсер не вставит точку с запятой. Код преобразуется в одну единственную строку:

```javascript
function() {}(window.options || {}).property
```

Теперь вы видите проблему и почему ругался парсер. В процессе написания Javascript, вы должны всегда ставить точку с запятой в конце выражения. К счастью, CoffeeScript обходит эту проблема, избавившись от точки с запятой в своем синтаксисе. Вместо этого точки с запятой автоматически вставляются (в нужные места) при компиляции Coffeescript в Javascript.

####Зарезервированные слова

Некоторые ключевые слова в JavaScript зарезервинованы для будущих версий языка, например, `const`, `enum` и `class`. Используя их в качестве имен переменных в вашем коде, вы можете получить непредсказуемые результаты; некоторые браузеры справятся с ними `на отлично`, а другие могут `сдохнуть`. CoffeeScript аккуратно обходит эту проблему путем обнаружения использования ключевых слов, экранируя их, если это требуется.

For example, let's say you were to use the reserved keyword class as a property on an object, your CoffeeScript might look like this:
Для примера, представим, что вам пришлось использовать ключевое слово `class` в качестве свойсва объекта. Ваш Coffeescript код будет выглядеть вот так:

```coffeescript
myObj = {
  delete: "I am a keyword!"
}
myObj.class = ->
```

Парсер CoffeeScript заметит, что вы используете зарезервированное ключевое слово и заэкранирует его:

```javascript
var myObj;
myObj = {
  "delete": "I am a keyword!"
};
myObj["class"] = function() {};
```

####Равенства

####Определение функции

####Свойства чисел

Одним из недостатков парсера Javascript является то, что, если мы ставим точку после числа, запись интерпрерируется как литерал числа с плавающей точкой, а не запрос значения свойтва объекта. Например, следующий код вызовет ошибку:
```javascript
5.toString();
```

Javascript парсер ожидает еще одно число после точки, и мы получим `Unexpected token error`, когда он дойдет до `toString()`. Сушествует два решения это проблемы: заключать число в скобки или добавлять еще одну точку.

```javascript
(5).toString();
5..toString();
```

К счастью, парсер CoffeeScript достаточно умен, чтобы справиться с этой проблемой, используя нотацию с двумя точками автоматически (как в примере выше) всякий раз, когда вы хотите получить доступ к свойтву числа.


##Недоисправленные вещи

####Использование eval

####Использование typeof

####Использование instanceof

####Использование delete

####Использование parseInt

####Строгий режим (Strict mode)

####Изменения в "строгом режиме"

####Использование "строгого режима"

####JavaScript Lint

[0]: https://en.wikipedia.org/wiki/Sun_Tzu
